{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Pedidos</title>
    <!-- Bootstrap CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/pedido.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <link rel="icon" type="image/png" href="{% static 'img/icon.png' %}">
    <style>
        /* Estilos para el stepper */
        .stepper-container {
            margin: 20px 0;
        }

        .stepper {
            display: flex;
            justify-content: space-between;
            position: relative;
        }

        .stepper::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #ddd;
            z-index: 1;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            flex: 1;
        }

        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            color: white;
        }

        .step.active .step-icon {
            background: #007bff;
        }

        .step.completed .step-icon {
            background: #28a745;
        }

        .step-text {
            font-size: 14px;
            color: #666;
            text-align: center;
        }

        .step.active .step-text {
            font-weight: bold;
            color: #007bff;
        }

        .step.completed .step-text {
            color: #28a745;
        }
        
        /* Estilo para imágenes de productos */
        .producto-img {
            max-width: 80px;
            max-height: 80px;
            object-fit: contain;
        }
    </style>
</head>
<body>

<!-- Barra de Navegación -->
<nav class="navbar navbar-expand-lg navbar-custom mb-4">
    <div class="container">
        <a href="{% url 'Ladingpage' %}"><i class="fa-solid fa-arrow-left"></i></a>
        <span class="navbar-brand d-none d-lg-block" style="margin-left: -16%;">Gestión de Pedidos</span>
       
        <!--search bar (barra de busqueda)-->
        <div class="group" id="search-group">
            <svg viewBox="0 0 24 24" aria-hidden="true" class="search-icon">
                <g>
                    <path d="M21.53 20.47l-3.66-3.66C19.195 15.24 20 13.214 20 11c0-4.97-4.03-9-9-9s-9 4.03-9 9 4.03 9 9 9c2.215 0 4.24-.804 5.808-2.13l3.66 3.66c.147.146.34.22.53.22s.385-.073.53-.22c.295-.293.295-.767.002-1.06zM3.5 11c0-4.135 3.365-7.5 7.5-7.5s7.5 3.365 7.5 7.5-3.365 7.5-7.5 7.5-7.5-3.365-7.5-7.5z"></path>
                </g>
            </svg>
            <input id="query" class="input" type="search" placeholder="Buscar Producto" name="searchbar">
        </div>
    </div>    
</nav>

<!-- Contenedor Principal -->
<div class="container">
    <h2 class="text-center my-4">Pedidos Realizados</h2>

    <table class="table table-bordered table-hover">
        <thead class="thead-secondary">
            <tr>
                <th>ID Pedido</th>
                <th>Cliente</th>
                <th>Fecha</th>
                <th>Total</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            
        {% for pedido in pedidos %}
        <tr>
            <td>{{ pedido.codigo_pedido }}</td>
            <td>{{ pedido.cliente }}</td>
            <td>{{ pedido.fecha|date:"Y-m-d" }}</td>
            <td>${{ pedido.total }}</td>
            <td>
            <button class="btn btn-info btn-sm" data-toggle="modal" data-target="#pedidoModal"
                    onclick="mostrarDetallesPedido('{{ pedido.codigo_pedido }}')">
                <i class="fas fa-eye"></i> Ver Detalles
            </button>

            <form action="{% url 'cancelar_pedido' pedido.codigo_pedido %}" method="post" style="display:inline;" class="cancel-pedido-form">
                {% csrf_token %}

                <button type="submit" class="btn btn-danger btn-sm">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </form>
            </td>
        </tr>
        {% endfor %}
        </tbody>

      
    </table>



    <div id="noResults" class="alert text-center mt-3" style="display:none;">
        No se encontró ningún resultado.
    </div>
</div>

<!-- Modal para Detalles del Pedido -->
<div class="modal fade" id="pedidoModal" tabindex="-1" role="dialog" aria-labelledby="pedidoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pedidoModalLabel">Detalles del Pedido</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body">
                <!-- Spinner de carga -->
                <div id="loadingSpinner" class="text-center py-4" style="display: none;">
                    <i class="fas fa-spinner fa-spin fa-3x"></i>
                    <p class="mt-2">Cargando detalles del pedido...</p>
                </div>

                <!-- Contenido dinámico -->
                <div id="pedidoContent">
                    <!-- Stepper para el estado del pedido -->
                    <div class="stepper-container mb-4">
                        <div class="stepper">
                            <div class="step" id="step1">
                                <div class="step-icon"><i class="fas fa-clipboard-check"></i></div>
                                <div class="step-text">En proceso</div>
                            </div>
                            <div class="step" id="step2">
                                <div class="step-icon"><i class="fas fa-truck"></i></div>
                                <div class="step-text">Enviado</div>
                            </div>
                            <div class="step" id="step3">
                                <div class="step-icon"><i class="fas fa-check-circle"></i></div>
                                <div class="step-text">Entregado</div>
                            </div>
                        </div>
                    </div>

                    <!-- Información básica del pedido -->
                    <div class="mb-4">
                        <p><strong>ID Pedido:</strong> <span id="pedidoId"></span></p>
                        <p><strong>Cliente:</strong> <span id="pedidoCliente"></span></p>
                        <p><strong>Fecha:</strong> <span id="pedidoFecha"></span></p>
                        <p><strong>Total:</strong> <span id="pedidoTotal"></span></p>
                    </div>
                    <hr>
                    
                    <!-- Tabla de artículos del pedido -->
                    <div class="table-responsive">
                        <table class="table">
                            <thead class="thead-secondary">
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Precio Unitario</th>
                                    <th>Total</th>
                                    <th>Imagen</th>
                                </tr>
                            </thead>
                            <tbody id="pedidoArticulos">
                                <!-- Los artículos se llenarán dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- SPEED DIAL - boton flotante -->
<div class="speed-dial" id="speedDial">
    <div class="speed-dial-actions" id="speedActions">
        <a class="action-button" href=""><i class="fa-brands fa-whatsapp" style="color: black;"></i></a>
        <a class="action-button" href="https://www.instagram.com/"><i class="fa-brands fa-instagram" style="color: black;"></i></a>
        <a class="action-button" href="https://www.facebook.com/?locale=es_LA"><i class="fa-brands fa-facebook-f" style="color: black;"></i></a>
    </div>
    <button class="fab">
        <span class="plus">+</span>
    </button>
</div>


<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>


<script>
// Función para obtener cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function mostrarDetallesPedido(codigoPedido) {
    // Mostrar spinner y ocultar contenido
    $('#loadingSpinner').show();
    $('#pedidoContent').hide();

    // Limpiar contenido anterior
    $('#pedidoId, #pedidoCliente, #pedidoFecha, #pedidoTotal').text('');
    $('#pedidoArticulos').empty();

    // Resetear stepper
    $('.step').removeClass('active completed');

    fetch(`/pedidos/${codigoPedido}/`)
        .then(response => {
            if (!response.ok) throw new Error('Pedido no encontrado');
            return response.json();
        })
        .then(data => {
            $('#loadingSpinner').hide();
            $('#pedidoContent').show();

            $('#pedidoId').text(data.codigo_pedido || codigoPedido);
            $('#pedidoCliente').text(data.cliente || '');
            $('#pedidoFecha').text(data.fecha || '');
            let total = parseFloat(data.total);
            let totalFormatted = total ? new Intl.NumberFormat('es-CO', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            }).format(total) : '0,00';

$('#pedidoTotal').text(totalFormatted);

            // Llenar artículos
            const articulosList = $('#pedidoArticulos');
            if (data.articulos && data.articulos.length) {
                data.articulos.forEach(art => {
                    articulosList.append(`
                        <tr>
                            <td>${art.nombre || ''}</td>
                            <td>${art.cantidad || ''}</td>
                           <td>
                          ${new Intl.NumberFormat('es-CO', {
                              style: 'currency',
                              currency: 'COP',
                              minimumFractionDigits: 0,
                              maximumFractionDigits: 2
                          }).format(parseFloat(art.precio_unitario || 0))}
                        </td>
                           <td>
                          ${new Intl.NumberFormat('es-CO', {
                              style: 'currency',
                              currency: 'COP',
                              minimumFractionDigits: 0,
                              maximumFractionDigits: 2
                          }).format(parseFloat(art.total || 0))}
                        </td>

                            <td>${art.imagen ? `<img src="${art.imagen}" class="producto-img">` : ''}</td>
                        </tr>
                    `);
                });
            } else {
                articulosList.append('<tr><td colspan="5" class="text-center">No hay artículos</td></tr>');
            }

            // Stepper dinámico según estado
            actualizarStepper(data.estado);
        })
        .catch(err => {
            console.error(err);
            $('#loadingSpinner').hide();
            Swal.fire(
                'Error',
                'Error al cargar los detalles del pedido.',
                'error'
            );
        });
}

// Stepper dinámico
function actualizarStepper(estado) {
    $('.step').removeClass('active completed');
    if (estado === 'Solicitado' || estado === 'En proceso' || estado === 'Aprobado') {
        // Azul solo en el primero
        $('#step1').addClass('active');
    } else if (estado === 'Enviado') {
        // Verde el primero, azul el segundo
        $('#step1').addClass('completed');
        $('#step2').addClass('active');
    } else if (estado === 'Entregado') {
        // Verde los dos primeros, azul el último
        $('#step1').addClass('completed');
        $('#step2').addClass('completed');
        $('#step3').addClass('active');
    }
}

// Botón flotante
document.addEventListener('DOMContentLoaded', function () {
    const speedDial = document.getElementById('speedDial');
    const speedActions = document.getElementById('speedActions');

    speedDial.addEventListener('mouseenter', () => {
        speedActions.style.display = 'flex';
    });

    speedDial.addEventListener('mouseleave', () => {
        speedActions.style.display = 'none';
    });
});

//buscador
  document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('query');
    const table = document.querySelector('table');
    const rows = table.querySelectorAll('tbody tr');
    const noResults = document.getElementById('noResults');

    searchInput.addEventListener('input', function () {
        const searchTerm = searchInput.value
            .toLowerCase()
            .normalize("NFD").replace(/[\u0300-\u036f]/g, '') // quita tildes
            .replace(/\s+/g, '') // quita espacios
            .replace(/\//g, '-');

        let anyVisible = false;

        rows.forEach(row => {
            // Unimos el texto de todas las celdas de la fila
            let rowText = '';
            row.querySelectorAll('td').forEach(cell => {
                rowText += (cell.textContent || cell.innerText) + ' ';
            });

            // Normalizamos el texto de la fila
            rowText = rowText
                .toLowerCase()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, '') // quita tildes
                .replace(/\s+/g, ''); // quita espacios

            if (rowText.includes(searchTerm)) {
                row.style.display = '';
                anyVisible = true;
            } else {
                row.style.display = 'none';
            }
        });

        // Mostrar mensaje si no hay resultados
        noResults.style.display = anyVisible ? 'none' : 'block';
    });
});


</script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>
</html>